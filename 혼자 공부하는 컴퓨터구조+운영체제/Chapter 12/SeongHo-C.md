<!--
bold 처리
** **

js 코드 작성
```js

```

링크
[보여질 단어](URL 주소)

형광펜 처리
` `
-->

## Chapter 12: 프로세스 동기화

<details>
<summary>Table of Contents</summary>

- 동기화란[:link:](#동기화란)
  - 동기화의 의미[:link:](#동기화의-의미)
  - 생산자와 소비자 문제[:link:](#생산자와-소비자-문제)
  - 공유 자원과 임계 구역[:link:](#공유-자원과-임계-구역)
- 동기화 기법[:link:](#동기화-기법)
  - 뮤텍스 락[:link:](#뮤텍스-락)
  - 세마포[:link:](#세마포)
  - 모니터[:link:](#모니터)
  </details>

### 동기화란

#### 동기화의 의미

- `프로세스 동기화`란 프로세스들 사이의 수행 시기를 맞추는 것을 의미한다.
  - 실행 순서 제어: 동시에 실행되는 프로세스를 올바른 순서대로 실행하기
  - 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기

#### 생산자와 소비자 문제

```js
총합 = 10

생산자() {
  버퍼에 데이터 삽입
  '총합' 변수 1 증가
}

소비자() {
  버퍼에서 데이터 빼내기
  '총합' 변수 1 감소
}
```

</br>

생산자 100,000번, 소비자 100,000번 동시에 실행

```js
// 소비자가 생산자의 작업이 끝나기도 전에 총합을 수정
초기 합계 : 10
producer, consumer 스레드 실행 이후 합계 : 63078
```

```js
// 생산자가 소비자의 작업이 끝나기도 전에 총합을 수정
초기 합계 : 10
producer, consumer 스레드 실행 이후 합계 : -13750
```

#### 공유 자원과 임계 구역

- 계좌 잔액 문제와 생산자 소비자 문제의 예시에서 동시에 실행되는 프로세스들은 전역 변수 '잔액', '총합'이라는 공동의 자원을 두고 작업을 했다. 이러한 자원을 `공유 자원`이라고 한다. 공유 자원은 전역 변수가 될 수도 있고, 파일이 될 수도 있고, 입출력장치, 보조기억장치가 될 수도 있다.
- 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역을 `임계 구역`이라고 한다.
- 임계 구역은 두 개 이상의 프로세스가 동시에 실행하면 안 되는 영역이지만, 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우가 있다. 이를 `레이스 컨디션`이라고 한다.

**`레이스 컨디션이 발생하는 근본적인 이유?`** </br>
컴퓨터는 고급 언어가 아닌 저급 언어를 실행하기 때문에 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 일어날 수 있다. 저급 언어를 실행하는 과정에서 문맥 교환이 일어난다면 레이스 컨디션이 발생한다.

운영체제는 이러한 임계 구역 문제를 아래 세 가지 원칙 하에 해결한다.

- `상호 배제`: 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
- `진행`: 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
- `유한 대기`: 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다(임계 구역에 들어오기 위해 무한정 대기해서는 안 된다).

### 동기화 기법

동기화를 위한 대표적인 도구 ⓵`뮤텍스 락`, ⓶`세마포`, ⓷`모니터`

#### 뮤텍스 락

- 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화 도구이다.
- 뮤텍스 락의 매우 단순한 형태는 하나의 전역 변수와 두 개의 함수로 구현할 수 있다.
  - 자물쇠 역할: 프로세스들이 공유하는 전역 변수 lock
  - 임계 구역을 잠그는 역할: acquire 함수
  - 임계 구역의 잠금을 해제하는 역할: release 함수

```js
acquire() {
  while(lock == true) // 만약 임계 구역이 잠겨 있다면
    ;                 // 임계 구역이 잠겨 있는지를 반복적으로 확인(바쁜 대기)
  lock = true;        // 만약 임계 구역이 잠겨 있지 않다면 임계 구역 잠금
}

release() {
  lock = false;       // 임계 구역 작업이 끝났으니 잠금 해제
}

acquire();            // 자물쇠 잠겨 있는지 확인, 잠겨 있지 않다면 잠그고 들어가기
// 임계 구역            // 임계 구역에서의 작업 진행
release();            // 자물쇠 반환
```

#### 세마포

⓵ 이진 세마포: 뮤텍스 락과 비슷한 개념 </br>
⓶ 카운팅 세마포: 여러 공유 자원을 다룰 수 있음

- 뮤텍스 락과 비슷하지만, 공유 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구이다.
- 세마포는 '멈춤' 신호와 '가도 좋다'는 신호로서 임계 구역을 관리한다. 즉, 프로세스는 임계 구역 앞에서 멈춤 신호를 받으면 잠시 기다리고, 가도 좋다는 신호를 받으면 그제서야 임계 구역에 들어가게 된다.
- 세마포는 뮤텍스 락과 비슷하게 하나의 변수와 두 개의 함수로 단순하게 구현할 수 있다.
  - 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타내는 `전역 변수 S`
  - 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 `wait 함수`
  - 임계 구역 앞에서 기다리는 프로세스에 '이제 가도 좋다'고 신호를 주는 `signal 함수`

```js
wait() {
  while(S <= 0) // 만일 임계 구역에 진입할 수 있는 프로세스 개수가 0 이하라면
  ;             // 사용할 수 있는 자원이 있는지 반복적으로 확인하고,(바쁜 대기)
  S--;          // 임계 구역에 진입할 수 있는 프로세스 개수가 하나 이상이면 S를 1 감소시키고 임계 구역 진입한다.
}

signal() {
  S++;          // 임계 구역에서의 작업을 마친 뒤 S를 1 증가시킨다.
}
```

- 바쁜 대기를 반복하며 확인할 시간에 CPU는 더 생산성 있는 작업을 할 수 있을 텐데, CPU 주기를 낭비한다는 점에서 손해이다. 그래서 실제로 세마포는 다른 더 좋은 방법을 사용한다.

```js
wait() {
  S--;
  if(S < 0) {
    add this process to Queue; // 해당 프로세스 PCB를 대기 큐에 삽입한다.
    sleep();                   // 대기 상태로 접어든다.
  }
}

signal() {
  S++;
  if(S <= 0) {
    remove a process p from Queue; // 대기 큐에 있는 프로세스 p를 제거한다.
    wakeup(p);                     // 프로세스 p를 대기 상태에서 준비 상태로 만든다.
  }
}
```

- 세마포를 이용해 프로세스의 순서를 제어하는 방법은 간단하다. 세마포의 변수 S를 0으로 두고 먼저 실행할 프로세스 뒤에 signal 함수, 다음에 실행할 프로세스 앞에 wait 함수를 붙이면 된다.

#### 모니터

- 세마포에 비하면 사용자가 사용하기에 훨씬 편리한 도구이다. 모니터는 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어 관리한다. 그리고 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근하도록 한다.
- 모니터는 공유 자원을 다루는 인터페이스에 접근하기 위한 큐(모니터에 진입하기 위한 큐)를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다.
- 모니터는 세마포와 마찬가지로 실행 순서 제어를 위한 동기화도 제공한다. 특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 모니터는 `조건 변수`를 사용하는데, 조건 변수는 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수이다.
- 조건 변수로는 wait와 signal 연산을 수행할 수 있다. </br> ⓵ 특정 프로세스가 아직 실행될 조건이 되지 않았을 때에는 wait를 통해 실행을 중단한다. </br> ⓶ 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행을 재개한다.

  <img width="500" alt="image" src="https://github.com/SeongHo-C/reading-books-for-programmers/assets/83394485/f2c30d71-3e94-4b77-b3e8-8a92f4e07d19">
